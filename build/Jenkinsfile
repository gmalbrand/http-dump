pipeline {
    agent none

    environment {
      REPOSITORY='gmalbrand/http-dump'
      CREDENTIALS=credentials('dockerhub-credentials')
    }

    stages {
        stage('Build & Tests') {
          agent {
            docker {
              label 'docker'
              image 'golang:1.19.3-alpine'
              args '-e GOCACHE=/tmp'
            }
          }
          steps {
            dir("${env.WORKSPACE}/src"){
              sh 'go build -o http-dump main.go'
            }
          }
        }

        stage('Publish image'){
          agent {
            label 'docker'
          }
          steps {
            sh 'echo $CREDENTIALS_PSW | docker login -u $CREDENTIALS_USR --password-stdin'
            sh 'docker build -t $REPOSITORY:$BUILD_NUMBER -f build/Dockerfile .'
          }
        }
    }
}
